---
layout: post
title: vid2vid
categories:
- Research
tags:
- gan
---

[vid2vid](https://arxiv.org/pdf/1808.06601.pdf)提出了一种通用的video to video的生成框架，可以用于很多视频生成任务。常用的pix2pix没有对temporal dynamics建模，所以不能直接用于video synthesis。下面就pose2body对着vid2vide [code](https://github.com/NVIDIA/vid2vid)简单记录一二。

推荐观看vid2vid [youtube](https://www.youtube.com/watch?v=GrP_aOSXt5U&feature=youtu.be)

### 1. Network Architecture

#### 1.1 Sequential Generator

sequential generator在生成当前帧时需要考虑：1）当前帧的输入图片；2）前几帧的输入图片；3）前几帧的生成图片。回看多少帧由[n_frames_G](https://github.com/NVIDIA/vid2vid/blob/master/options/base_options.py#L58)设置，如下图中n_frames_G设置为3：

![CompositeGenerator](https://raw.githubusercontent.com/7color94/7color94.github.io/master/imgs/vid2vid/CompositeGenerator.png)

sequential generator可以得到当前帧的预测图intermediate image、前一帧到当前帧的光流图flow map和occlusion mask。之后当前帧的生成结果由前一帧经由光流变化后的图片（img_warp）和当前帧的预测图（img_raw）通过mask [加权](https://github.com/NVIDIA/vid2vid/blob/master/models/networks.py#L188)而成。

同时对于高分辨率的图片生成，和pix2pixHD一样，提出了coarse-to-fine的[generator](https://github.com/NVIDIA/vid2vid/blob/master/models/networks.py#L201)，由[n_scales_spatial](https://github.com/NVIDIA/vid2vid/blob/master/options/base_options.py#L59)控制：

![CompositeLocalGenerator](https://raw.githubusercontent.com/7color94/7color94.github.io/master/imgs/vid2vid/CompositeLocalGenerator.png)

如果是采用coarse-to-fine generator，在训练时可以通过设置[niter_fix_global](https://github.com/NVIDIA/vid2vid/blob/master/options/train_options.py#L41)让Local 部分（高分辨率部分）单独先训几个epoch，和pix2pixHD中做法类似。

#### 1.2 Image Discriminator

image discriminator的目的是给定相同的图片输入，让生成帧和真实帧保持一致。这和pix2pixHD的discriminator并无差别，结构也采用了Multi-scale PatchGAN。

#### 1.3 Video Discriminator

video discriminator的目的是给定相同的光流，让连续的生成帧之间的光流信息和连续的真实帧之间的保持一致。所以image discriminator作用在图片上，video discriminator作用在光流上。

另外，vid2vid设计了temporally multi-scale video discriminator。这里“multi-scale”目的是采样连续帧的密度由紧密到稀疏，以便捕捉short-term和long-term的光流一致性，具体采用细节在代码[get_skipped_frames](https://github.com/NVIDIA/vid2vid/blob/master/train.py#L273)中体现。每个“scale”（密度）的video discriminator都是一个Multi-scale PatchGAN。

### 2. DataLoader

#### 2.1 PoseDataset

[PoseDataset](https://github.com/NVIDIA/vid2vid/blob/master/data/pose_dataset.py)用来加载openpose、densepose的label和真实的img，同时在训练时做[random scale](https://github.com/NVIDIA/vid2vid/blob/master/data/base_dataset.py)和[random crop](https://github.com/NVIDIA/vid2vid/blob/master/data/base_dataset.py#L93)。

### 3. Training

vid2vid训练时的loss比较多。

### 4. Test